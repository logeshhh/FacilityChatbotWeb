<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Facility Chatbot</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { margin:0; padding:0; }
  .chat-container { 
    max-height: 80vh; 
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    gap: 0.5rem; 
    flex: 1 1 auto;
  }
  .chat-container::-webkit-scrollbar { width: 6px; }
  .chat-container::-webkit-scrollbar-thumb { background-color: rgba(100,100,100,0.3); border-radius: 3px; }

  .chat-bubble { 
    padding: 0.75rem 1rem; 
    border-radius: 0.75rem; 
    word-wrap: break-word; 
    white-space: pre-wrap; 
    flex-shrink: 0; 
    max-width: 90%; 
  }
  .user-bubble { 
    background-color: #e5e7eb; 
    color: #1f2937; 
    align-self: flex-end; 
  }
  .bot-bubble { 
    background-color: #3b82f6; 
    color: #ffffff; 
    align-self: flex-start; 
  }
</style>
</head>
<body class="bg-gray-100 font-sans p-4 flex flex-col items-center min-h-screen">
<div class="bg-white rounded-xl shadow-lg p-6 flex flex-col w-full max-w-3xl h-[calc(100vh-2rem)]">

  <div class="text-center pb-4 border-b border-gray-200">
    <h1 class="text-xl font-bold text-gray-800">Facility Chatbot</h1>
    <p class="text-sm text-gray-500 mt-1">Ask me anything about the facility documents.</p>
  </div>

  <div id="chat-container" class="flex-grow my-4 chat-container">
    <!-- default bot message will load via JS -->
  </div>

  <div class="pt-4 border-t border-gray-200 flex items-center space-x-2">
    <textarea id="user-input" placeholder="Type a message..." class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="1"></textarea>
    <button id="send-button" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Send</button>
    <button id="stop-button" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Stop</button>
  </div>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const userInput = document.getElementById('user-input');
let controller = null;
let botLoadingDiv = null;

// Auto-resize textarea
userInput.addEventListener('input', () => {
  userInput.style.height = "auto";
  userInput.style.height = (userInput.scrollHeight) + "px";
});

// Send user message
async function sendMessage() {
  const message = userInput.value.trim();
  if (!message) return;
  userInput.value = '';
  appendUserMessage(message);
  appendBotLoading();

  controller = new AbortController();
  try {
    const res = await fetch(`/chat/default`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message}),
      signal: controller.signal
    });
    const data = await res.json();
    appendBotMessage(data.response);
  } catch(err) {
    console.log('Stopped or error', err);
    removeBotLoading();
  }
}

// Append user message
function appendUserMessage(text) {
  const div = document.createElement('div');
  div.className = 'flex items-start justify-end';
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble user-bubble shadow';
  bubble.textContent = text;
  div.appendChild(bubble);
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Append bot loading bubble
function appendBotLoading() {
  botLoadingDiv = document.createElement('div');
  botLoadingDiv.className = 'flex items-start';
  const avatar = document.createElement('div');
  avatar.className = 'w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white';
  avatar.textContent = 'ðŸ¤–';
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble bot-bubble shadow';
  bubble.textContent = 'Typing...';
  botLoadingDiv.appendChild(avatar);
  botLoadingDiv.appendChild(bubble);
  chatContainer.appendChild(botLoadingDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}
function removeBotLoading() { if (botLoadingDiv) botLoadingDiv.remove(); }

// Append bot message
function appendBotMessage(text) {
  removeBotLoading();
  const div = document.createElement('div');
  div.className = 'flex items-start';
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble bot-bubble shadow';
  bubble.textContent = text;
  div.appendChild(createBotAvatarWrapper(bubble));
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Helper: wrap bot bubble with avatar
function createBotAvatarWrapper(bubble) {
  const wrapper = document.createElement('div');
  wrapper.className = 'flex items-start space-x-2';
  const avatar = document.createElement('div');
  avatar.className = 'w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white';
  avatar.textContent = 'ðŸ¤–';
  wrapper.appendChild(avatar);
  wrapper.appendChild(bubble);
  return wrapper;
}

// Event listeners
document.getElementById('send-button').addEventListener('click', sendMessage);
document.getElementById('stop-button').addEventListener('click', () => { if (controller) controller.abort(); });
userInput.addEventListener('keypress', e => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

// Load default bot message
appendBotMessage("Hello! I'm your local facility management assistant. How can I help?");
</script>
</body>
</html>
